<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>猫猫财神登门</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&family=Long+Cang&display=swap" rel="stylesheet" />
  <style>
    :root {
      --red-1: #8f0f1d;
      --red-2: #c1192b;
      --red-3: #420610;
      --gold-1: #ffd256;
      --gold-2: #f1a80f;
      --ink: #251007;
      --ease-out: cubic-bezier(0.2, 0.75, 0.16, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      display: grid;
      place-items: center;
      overflow: hidden;
      color: #fff3c8;
      font-family: "ZCOOL QingKe HuangYou", "PingFang SC", sans-serif;
      background:
        radial-gradient(circle at 14% 8%, #ffe07d59 0%, transparent 26%),
        radial-gradient(circle at 86% 10%, #ffb14f4d 0%, transparent 24%),
        radial-gradient(circle at 50% 90%, #b80e2b35 0%, transparent 35%),
        linear-gradient(155deg, #290b2f 0%, var(--red-1) 38%, var(--red-3) 100%);
    }

    .festival {
      position: relative;
      width: min(1200px, 100vw);
      height: min(760px, 100vh);
      overflow: hidden;
      isolation: isolate;
    }

    .festival::before {
      content: "";
      position: absolute;
      inset: 10% 8%;
      background:
        radial-gradient(circle at center, #ffe27f4d 0%, transparent 58%),
        repeating-linear-gradient(30deg, #ffffff0a 0 10px, transparent 10px 20px);
      z-index: -1;
      opacity: 0.6;
    }

    .title {
      position: absolute;
      top: calc(env(safe-area-inset-top, 0px) + 0.05%);
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-align: center;
      font-family: "Long Cang", cursive;
      font-size: clamp(2rem, 6.2vw, 4.8rem);
      letter-spacing: 0.05em;
      text-shadow: 0 0 22px #ffcf56b2;
      opacity: 0;
      transform: translateY(-16px);
      transition: 700ms var(--ease-out);
      z-index: 20;
      pointer-events: none;
    }

    body.phase-enter .title,
    body.phase-give .title {
      opacity: 1;
      transform: translateY(0);
    }

    .lantern {
      position: absolute;
      top: -8px;
      width: clamp(40px, 5vw, 62px);
      aspect-ratio: 0.78;
      border-radius: 50% 50% 44% 44%;
      background: linear-gradient(180deg, #ec3646, #8f0b1d);
      border: 3px solid #f0ba3a;
      box-shadow: inset 0 0 0 3px #f8d87947, 0 10px 18px #00000045;
      animation: sway var(--dur) ease-in-out infinite;
      transform-origin: top center;
    }

    .lantern::before {
      content: "";
      position: absolute;
      top: -24px;
      left: 50%;
      width: 2px;
      height: 24px;
      transform: translateX(-50%);
      background: #f4cd5d;
    }

    .lantern::after {
      content: "";
      position: absolute;
      bottom: -16px;
      left: 50%;
      width: 12px;
      height: 16px;
      transform: translateX(-50%);
      border-radius: 2px 2px 6px 6px;
      background: linear-gradient(180deg, #ffe898, #f0a91d);
    }

    .lantern.left {
      left: 6%;
      --dur: 3.8s;
    }

    .lantern.right {
      right: 6%;
      --dur: 4.2s;
    }

    .stage-shadow {
      position: absolute;
      left: 50%;
      bottom: 11%;
      width: min(920px, 94vw);
      height: clamp(82px, 12vw, 120px);
      transform: translateX(-50%);
      border-radius: 50%;
      background: radial-gradient(circle at center, #ffd76c4f, transparent 72%);
      filter: blur(2px);
    }

    .door-zone {
      position: absolute;
      left: 50%;
      bottom: 13%;
      width: min(50vw, 420px);
      height: min(70vw, 500px);
      transform: translateX(-50%);
      perspective: 1400px;
      z-index: 4;
    }

    .gate-crown {
      position: absolute;
      left: -10%;
      top: -18%;
      width: 120%;
      height: 22%;
      border-radius: 14px 14px 18px 18px;
      background: linear-gradient(180deg, #7a111f, #550a14);
      border: 5px solid #efbf53;
      box-shadow: 0 14px 24px #00000057, inset 0 0 0 3px #ffde8b30;
      display: grid;
      place-items: center;
      z-index: 9;
    }

    .gate-crown::before {
      content: "";
      position: absolute;
      inset: 10% 5%;
      border-radius: 10px 10px 16px 16px;
      border: 2px solid #ffd98a6e;
    }

    .gate-plaque {
      position: relative;
      z-index: 10;
      padding: 6px 18px;
      border: 2px solid #f6d17e;
      border-radius: 8px;
      color: #ffe9ad;
      background: linear-gradient(180deg, #6f0918, #4c0812);
      letter-spacing: 0.12em;
      font-size: clamp(0.95rem, 2.1vw, 1.3rem);
      text-shadow: 0 0 8px #00000088;
    }

    .gate-column {
      position: absolute;
      top: 8%;
      width: 12%;
      height: 96%;
      border-radius: 14px;
      border: 3px solid #e9b848;
      background:
        repeating-linear-gradient(
          180deg,
          #b9162a 0 18px,
          #921224 18px 36px
        );
      box-shadow: inset 0 0 0 2px #ffd76b4a;
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .gate-column.left {
      left: -11%;
    }

    .gate-column.right {
      right: -11%;
    }

    .couplet-text {
      writing-mode: vertical-rl;
      text-orientation: upright;
      letter-spacing: 0.18em;
      line-height: 1.1;
      font-size: clamp(0.95rem, 1.95vw, 1.28rem);
      color: #ffe8a5;
      text-shadow: 0 0 6px #300000cc;
      padding: 10px 4px;
      border-radius: 8px;
      border: 1px solid #f6c970;
      background: linear-gradient(180deg, #d81a30, #9e1424);
      box-shadow: inset 0 0 0 1px #ffefb233;
      z-index: 2;
      user-select: none;
    }

    .door-frame {
      position: absolute;
      inset: 6% 0 0;
      border: 12px solid var(--gold-2);
      border-radius: 16px;
      background: linear-gradient(180deg, #7c101f, #4f0a14);
      overflow: hidden;
      box-shadow: 0 18px 35px #0000005e, inset 0 0 0 7px #d83245;
      z-index: 3;
    }

    .door-frame::before {
      content: "";
      position: absolute;
      left: 50%;
      top: 0;
      width: 6px;
      height: 100%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, #ffd469, #bb7a0c);
      z-index: 2;
      opacity: 0.7;
    }

    .door {
      position: absolute;
      top: 0;
      width: 50%;
      height: 100%;
      border: 4px solid #efbf55;
      background: linear-gradient(180deg, #d02338, #881022);
      transition: transform 1200ms var(--ease-out);
      z-index: 3;
    }

    .door.left {
      left: 0;
      transform-origin: left center;
    }

    .door.right {
      right: 0;
      transform-origin: right center;
    }

    .door .label {
      position: absolute;
      inset: 13% 10%;
      border: 2px solid #ffe18d;
      border-radius: 8px;
      display: grid;
      place-items: center;
      color: #ffeaa3;
      font-size: clamp(1.1rem, 3vw, 1.8rem);
      text-shadow: 0 0 8px #00000066;
    }

    .door .ring {
      position: absolute;
      top: 50%;
      width: 18px;
      aspect-ratio: 1;
      border-radius: 50%;
      transform: translateY(-50%);
      background: radial-gradient(circle at 30% 28%, #fff3c0, #ca8208);
      box-shadow: 0 0 0 6px #996310;
    }

    .door.left .ring {
      right: 16%;
    }

    .door.right .ring {
      left: 16%;
    }

    .knock-line {
      position: absolute;
      left: 50%;
      bottom: calc(13% + min(70vw, 500px) + 16px);
      transform: translateX(-50%);
      padding: 9px 16px;
      border: 2px solid #ffe08a;
      border-radius: 999px;
      background: #37160fd9;
      letter-spacing: 0.12em;
      font-size: clamp(1rem, 2.4vw, 1.4rem);
      opacity: 0;
    }

    body.phase-knock .door-frame {
      animation: door-shake 0.46s ease-in-out 0s 4;
    }

    body.phase-knock .knock-line {
      opacity: 1;
      animation: echo 0.46s ease-in-out 0s 4;
    }

    body.phase-open .door.left,
    body.phase-enter .door.left,
    body.phase-give .door.left {
      transform: rotateY(-112deg);
    }

    body.phase-open .door.right,
    body.phase-enter .door.right,
    body.phase-give .door.right {
      transform: rotateY(112deg);
    }

    .cat-caishen {
      position: absolute;
      left: 50%;
      bottom: 12.5%;
      width: min(50vw, 560px);
      opacity: 0;
      transform: translate(-50%, 14%) scale(0.56);
      transform-origin: center bottom;
      transition: transform 1850ms var(--ease-out), opacity 720ms var(--ease-out);
      filter: drop-shadow(0 18px 24px #0000005d);
      z-index: 2;
    }

    body.phase-open .cat-caishen {
      opacity: 0.25;
      transform: translate(-50%, 11%) scale(0.62);
    }

    .cat-stage {
      width: 100%;
      filter: drop-shadow(0 14px 20px #00000066);
    }

    .cat-stage img {
      width: 100%;
      height: auto;
      display: block;
      animation: breathe 2.8s ease-in-out infinite;
    }

    body.phase-enter .cat-caishen,
    body.phase-give .cat-caishen {
      opacity: 1;
      transform: translate(-50%, 0) scale(1);
      z-index: 7;
    }

    .cat-caption {
      margin-top: 12px;
      text-align: center;
      font-size: clamp(0.95rem, 2vw, 1.25rem);
      color: #ffeeb2;
      text-shadow: 0 0 8px #4a0000;
    }

    .gift-tag {
      position: absolute;
      right: -8%;
      bottom: 20%;
      padding: 10px 16px;
      border-radius: 12px;
      border: 2px solid #a96a08;
      background: linear-gradient(180deg, #ffe18a, #f1aa16);
      color: #8a1313;
      font-size: clamp(1rem, 2vw, 1.2rem);
      box-shadow: 0 10px 16px #0000004f;
      opacity: 0;
      transform: translateY(10px) rotate(-6deg);
      transition: 500ms var(--ease-out);
    }

    body.phase-give .gift-tag {
      opacity: 1;
      transform: translateY(0) rotate(-6deg);
    }

    .rain-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .hongbao-rain {
      z-index: 2;
    }

    .yuanbao-rain {
      z-index: 1;
    }

    .hongbao-drop {
      position: absolute;
      top: -14%;
      left: var(--x);
      width: var(--w);
      height: calc(var(--w) * 1.22);
      border-radius: 8px;
      border: 2px solid #f5cf77;
      background:
        linear-gradient(180deg, #eb2c42 0%, #be152b 100%);
      box-shadow: 0 10px 14px #0000003a;
      animation: rain-fall var(--dur) linear forwards;
      transform: translate3d(0, -10vh, 0);
      will-change: transform;
    }

    .hongbao-drop::before {
      content: "福";
      position: absolute;
      left: 50%;
      top: 50%;
      width: 58%;
      aspect-ratio: 1;
      transform: translate(-50%, -50%) rotate(45deg);
      border: 1px solid #ffebbd;
      background: #c8192f;
      color: #ffe8a5;
      display: grid;
      place-items: center;
      font-size: calc(var(--w) * 0.34);
      text-shadow: 0 0 8px #00000066;
    }

    .yuanbao-drop {
      position: absolute;
      top: -12%;
      left: var(--x);
      width: var(--w);
      height: calc(var(--w) * 0.72);
      border-radius: 56% 56% 40% 40%;
      border: 2px solid #9d6107;
      background:
        linear-gradient(180deg, #ffe28b 0%, #f4b02d 58%, #df9300 100%);
      box-shadow: 0 9px 13px #00000042;
      animation: rain-fall var(--dur) linear forwards;
      transform: translate3d(0, -10vh, 0);
      will-change: transform;
    }

    .yuanbao-drop::before {
      content: "";
      position: absolute;
      left: 50%;
      top: -32%;
      width: 46%;
      height: 40%;
      transform: translateX(-50%);
      border-radius: 50%;
      border: 2px solid #9d6107;
      background: linear-gradient(180deg, #ffe8a4, #efb53e);
    }

    .wish {
      position: absolute;
      left: 50%;
      bottom: 7%;
      transform: translateX(-50%) translateY(10px);
      width: min(92vw, 820px);
      text-align: center;
      font-size: clamp(1.3rem, 3.3vw, 2.05rem);
      text-shadow: 0 0 14px #851500;
      opacity: 0;
      transition: 800ms var(--ease-out);
    }

    body.phase-give .wish {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .controls {
      position: absolute;
      right: min(4vw, 22px);
      bottom: min(4vw, 20px);
      display: flex;
      gap: 10px;
      align-items: center;
      z-index: 30;
    }

    .btn {
      border: 2px solid #ffde82;
      border-radius: 12px;
      padding: 10px 14px;
      background: #4a1020de;
      color: #ffedb6;
      font-family: inherit;
      font-size: 1rem;
      cursor: pointer;
      transition: 220ms ease;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      background: #6b1830;
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .music-hint {
      position: absolute;
      left: 50%;
      top: 12%;
      transform: translateX(-50%);
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #ffd86c;
      background: #2b1109de;
      color: #ffecae;
      opacity: 0;
      transition: 260ms ease;
      pointer-events: none;
    }

    body.music-gesture .music-hint {
      opacity: 1;
    }

    .credit {
      position: fixed;
      left: 50%;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 8px);
      transform: translateX(-50%);
      font-size: clamp(0.72rem, 1.7vw, 0.9rem);
      letter-spacing: 0.04em;
      color: #ffe7a6cc;
      text-shadow: 0 0 6px #4a1000a8;
      z-index: 40;
      pointer-events: none;
      white-space: nowrap;
    }

    @keyframes door-shake {
      0%, 100% { transform: translateX(0); }
      30% { transform: translateX(-4px); }
      70% { transform: translateX(4px); }
    }

    @keyframes echo {
      0%, 100% { transform: translateX(-50%) scale(1); }
      45% { transform: translateX(-50%) scale(1.06); }
    }

    @keyframes rain-fall {
      0% {
        transform: translate3d(0, -10vh, 0) rotate(var(--r0));
        opacity: 0.05;
      }
      12% {
        opacity: 1;
      }
      100% {
        transform: translate3d(var(--drift), 120vh, 0) rotate(var(--r1));
        opacity: 0.95;
      }
    }

    @keyframes sway {
      0%, 100% { transform: rotate(-3deg); }
      50% { transform: rotate(3deg); }
    }

    @keyframes breathe {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }

    @media (max-width: 960px) {
      .door-zone {
        left: 50%;
        width: min(52vw, 390px);
      }

      .cat-caishen {
        width: min(52vw, 480px);
        bottom: 14%;
      }

      body.phase-enter .cat-caishen,
      body.phase-give .cat-caishen {
        transform: translate(-50%, 0) scale(1);
      }
    }

    @media (max-width: 760px) {
      .festival {
        height: 100vh;
      }

      .title {
        top: calc(env(safe-area-inset-top, 0px) + 0%);
        font-size: clamp(1.45rem, 6.6vw, 2.6rem);
        letter-spacing: 0.03em;
      }

      .door-zone {
        left: 50%;
        right: auto;
        bottom: 16%;
        width: min(62vw, 320px);
        height: min(84vw, 440px);
        transform: translateX(-50%);
      }

      .knock-line {
        bottom: calc(16% + min(84vw, 440px) + 12px);
      }

      .cat-caishen {
        width: min(76vw, 405px);
        bottom: 23%;
        transform: translate(-50%, 14%) scale(0.52);
      }

      body.phase-open .cat-caishen {
        transform: translate(-50%, 12%) scale(0.58);
      }

      body.phase-enter .cat-caishen,
      body.phase-give .cat-caishen {
        transform: translate(-50%, 0) scale(0.94);
      }

      .cat-caption {
        font-size: 1rem;
      }

      .couplet-text {
        font-size: clamp(0.9rem, 3vw, 1.08rem);
        letter-spacing: 0.16em;
      }
    }

    @media (max-width: 520px) {
      .festival {
        min-height: 100vh;
      }

      .title {
        top: calc(env(safe-area-inset-top, 0px) + 0%);
        font-size: clamp(1.2rem, 6.2vw, 1.82rem);
        letter-spacing: 0.01em;
      }

      .door-zone {
        left: 50%;
        right: auto;
        bottom: 13%;
        width: min(64vw, 300px);
        height: min(88vw, 430px);
        transform: translateX(-50%);
      }

      .knock-line {
        bottom: calc(13% + min(88vw, 430px) + 10px);
      }

      .cat-caishen {
        width: min(82vw, 360px);
        bottom: 25%;
        transform: translate(-50%, 14%) scale(0.49);
      }

      body.phase-open .cat-caishen {
        transform: translate(-50%, 12%) scale(0.56);
      }

      body.phase-enter .cat-caishen,
      body.phase-give .cat-caishen {
        transform: translate(-50%, 0) scale(0.9);
      }

      .controls {
        left: 50%;
        right: auto;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 58px);
        transform: translateX(-50%);
      }

      .wish {
        bottom: 14%;
        font-size: clamp(1.05rem, 5.2vw, 1.35rem);
      }

      .gate-column {
        width: 13%;
      }

      .couplet-text {
        font-size: 0.86rem;
        padding: 8px 3px;
      }
    }
  </style>
</head>
<body>
  <main class="festival">
    <h1 class="title">初五迎财神 八方来财</h1>

    <span class="lantern left"></span>
    <span class="lantern right"></span>
    <div class="stage-shadow"></div>

    <section class="door-zone" aria-label="大门">
      <div class="gate-crown">
        <span class="gate-plaque">财运亨通</span>
      </div>
      <span class="gate-column left">
        <span class="couplet-text">神佑八方利似春</span>
      </span>
      <span class="gate-column right">
        <span class="couplet-text">马奔四海财如水</span>
      </span>
      <div class="door-frame">
        <div class="door left">
          <div class="label">招财</div>
          <span class="ring"></span>
        </div>
        <div class="door right">
          <div class="label">进宝</div>
          <span class="ring"></span>
        </div>
      </div>
    </section>

    <p class="knock-line">咚咚咚，猫猫财神到</p>

    <figure class="cat-caishen">
      <div class="cat-stage">
        <img src="assets/cat-caishen.png" alt="两只猫财神图" />
      </div>
      <figcaption class="cat-caption">两位财神猫进门送福</figcaption>
    </figure>

    <div class="rain-layer yuanbao-rain" id="yuanbaoRain"></div>
    <div class="rain-layer hongbao-rain" id="hongbaoRain"></div>
    <p class="wish">喵财神进门，八方来财，金银满仓！</p>

    <p class="music-hint">已自动播放，iPhone 轻触页面可立即开声</p>

    <div class="controls">
      <button class="btn" id="musicBtn" type="button">关闭音乐</button>
      <button class="btn" id="replayBtn" type="button">再迎一次</button>
    </div>
  </main>
  <p class="credit">chillwang的AI无限公司出品</p>

  <audio id="bgm" preload="auto" loop autoplay playsinline webkit-playsinline x5-playsinline>
    <source src="assets/bafanglaicai.mp3" type="audio/mpeg" />
  </audio>

  <script>
    const phases = ["phase-knock", "phase-open", "phase-enter", "phase-give"];
    const phaseTimes = [0, 1700, 2800, 4300];
    const timers = [];
    const body = document.body;

    const replayBtn = document.getElementById("replayBtn");
    const musicBtn = document.getElementById("musicBtn");
    const hongbaoRain = document.getElementById("hongbaoRain");
    const yuanbaoRain = document.getElementById("yuanbaoRain");
    const bgm = document.getElementById("bgm");
    const isIOS = /iP(hone|ad|od)/.test(navigator.userAgent)
      || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

    let wantsMusic = true;
    let musicAvailable = true;
    let audioCtx = null;
    let rainRunning = false;
    let hongbaoTimer = null;
    let yuanbaoTimer = null;
    let startedMutedAutoplay = false;

    function clearStory() {
      phases.forEach((name) => body.classList.remove(name));
      while (timers.length) {
        clearTimeout(timers.pop());
      }
      stopRains();
    }

    function stopRains() {
      rainRunning = false;
      if (hongbaoTimer) {
        clearInterval(hongbaoTimer);
        hongbaoTimer = null;
      }
      if (yuanbaoTimer) {
        clearInterval(yuanbaoTimer);
        yuanbaoTimer = null;
      }
      hongbaoRain.innerHTML = "";
      yuanbaoRain.innerHTML = "";
    }

    function spawnHongbaoDrop() {
      if (!rainRunning) return;
      const packet = document.createElement("span");
      const w = 22 + Math.floor(Math.random() * 22);
      packet.className = "hongbao-drop";
      packet.style.setProperty("--x", `${4 + Math.random() * 92}%`);
      packet.style.setProperty("--w", `${w}px`);
      packet.style.setProperty("--dur", `${4100 + Math.floor(Math.random() * 2400)}ms`);
      packet.style.setProperty("--drift", `${-85 + Math.floor(Math.random() * 170)}px`);
      packet.style.setProperty("--r0", `${-50 + Math.floor(Math.random() * 100)}deg`);
      packet.style.setProperty("--r1", `${-500 + Math.floor(Math.random() * 1000)}deg`);
      packet.addEventListener("animationend", () => packet.remove(), { once: true });
      hongbaoRain.appendChild(packet);
    }

    function spawnYuanbaoDrop() {
      if (!rainRunning) return;
      const ingot = document.createElement("span");
      const w = 24 + Math.floor(Math.random() * 22);
      ingot.className = "yuanbao-drop";
      ingot.style.setProperty("--x", `${6 + Math.random() * 88}%`);
      ingot.style.setProperty("--w", `${w}px`);
      ingot.style.setProperty("--dur", `${4600 + Math.floor(Math.random() * 2600)}ms`);
      ingot.style.setProperty("--drift", `${-60 + Math.floor(Math.random() * 120)}px`);
      ingot.style.setProperty("--r0", `${-26 + Math.floor(Math.random() * 52)}deg`);
      ingot.style.setProperty("--r1", `${-240 + Math.floor(Math.random() * 480)}deg`);
      ingot.addEventListener("animationend", () => ingot.remove(), { once: true });
      yuanbaoRain.appendChild(ingot);
    }

    function startRains() {
      if (rainRunning) return;
      rainRunning = true;

      for (let i = 0; i < 16; i += 1) {
        setTimeout(() => spawnHongbaoDrop(), i * 70);
      }
      for (let i = 0; i < 10; i += 1) {
        setTimeout(() => spawnYuanbaoDrop(), i * 90);
      }

      hongbaoTimer = setInterval(() => {
        const burst = 1 + Math.floor(Math.random() * 3);
        for (let i = 0; i < burst; i += 1) spawnHongbaoDrop();
      }, 170);

      yuanbaoTimer = setInterval(() => {
        const burst = Math.random() < 0.72 ? 1 : 2;
        for (let i = 0; i < burst; i += 1) spawnYuanbaoDrop();
      }, 280);
    }

    async function ensureSfxReady() {
      const AudioContextCtor = window.AudioContext || window.webkitAudioContext;
      if (!AudioContextCtor) return false;
      if (!audioCtx) audioCtx = new AudioContextCtor();
      if (audioCtx.state === "suspended") {
        try {
          await audioCtx.resume();
        } catch (_) {
          return false;
        }
      }
      return audioCtx.state === "running";
    }

    function playKnockHit(offsetSec) {
      if (!audioCtx) return;
      const at = audioCtx.currentTime + offsetSec;

      const tone = audioCtx.createOscillator();
      tone.type = "triangle";
      tone.frequency.setValueAtTime(185, at);
      tone.frequency.exponentialRampToValueAtTime(82, at + 0.16);

      const toneGain = audioCtx.createGain();
      toneGain.gain.setValueAtTime(0.0001, at);
      toneGain.gain.exponentialRampToValueAtTime(0.12, at + 0.012);
      toneGain.gain.exponentialRampToValueAtTime(0.0001, at + 0.18);

      const noiseBuffer = audioCtx.createBuffer(1, Math.floor(audioCtx.sampleRate * 0.09), audioCtx.sampleRate);
      const channel = noiseBuffer.getChannelData(0);
      for (let i = 0; i < channel.length; i += 1) {
        channel[i] = (Math.random() * 2 - 1) * 0.55;
      }

      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuffer;

      const lowpass = audioCtx.createBiquadFilter();
      lowpass.type = "lowpass";
      lowpass.frequency.setValueAtTime(1200, at);

      const noiseGain = audioCtx.createGain();
      noiseGain.gain.setValueAtTime(0.0001, at);
      noiseGain.gain.exponentialRampToValueAtTime(0.07, at + 0.01);
      noiseGain.gain.exponentialRampToValueAtTime(0.0001, at + 0.11);

      const master = audioCtx.createGain();
      master.gain.value = 0.9;
      master.connect(audioCtx.destination);

      tone.connect(toneGain).connect(master);
      noise.connect(lowpass).connect(noiseGain).connect(master);

      tone.start(at);
      tone.stop(at + 0.2);
      noise.start(at);
      noise.stop(at + 0.12);
    }

    async function playKnockSequence() {
      const ready = await ensureSfxReady();
      if (!ready) return;
      [0, 0.43, 0.86, 1.29].forEach((offset) => playKnockHit(offset));
    }

    function playStory() {
      clearStory();
      phaseTimes.forEach((ms, index) => {
        const phase = phases[index];
        timers.push(setTimeout(() => {
          body.classList.add(phase);
          if (phase === "phase-knock") playKnockSequence();
          if (phase === "phase-open") startRains();
        }, ms));
      });
    }

    function updateMusicBtn() {
      if (!musicAvailable) {
        musicBtn.disabled = true;
        musicBtn.textContent = "音乐不可用";
        return;
      }
      if (bgm.paused) {
        musicBtn.textContent = "开启音乐";
      } else if (bgm.muted) {
        musicBtn.textContent = "开启声音";
      } else {
        musicBtn.textContent = "关闭音乐";
      }
    }

    async function tryPlayMusic() {
      if (!wantsMusic || !musicAvailable) return;
      try {
        bgm.muted = false;
        bgm.volume = 0.48;
        await bgm.play();
        startedMutedAutoplay = false;
        body.classList.remove("music-gesture");
      } catch (_) {
        try {
          // Fallback for strict autoplay policies: start muted, unmute on first interaction.
          bgm.muted = true;
          await bgm.play();
          startedMutedAutoplay = true;
          body.classList.add("music-gesture");
        } catch (_) {
          startedMutedAutoplay = false;
          bgm.muted = false;
          body.classList.add("music-gesture");
        }
      }
      updateMusicBtn();
    }

    function scheduleAutoplayRetries() {
      [180, 680, 1400].forEach((ms) => {
        setTimeout(() => {
          if (wantsMusic && bgm.paused) tryPlayMusic();
        }, ms);
      });
    }

    function autoClickEnableMusic() {
      if (!musicAvailable) return;
      const needEnable = bgm.paused || bgm.muted
        || musicBtn.textContent === "开启音乐"
        || musicBtn.textContent === "开启声音";
      if (!needEnable) return;
      wantsMusic = true;
      musicBtn.click();
    }

    function scheduleAutoMusicButtonClicks() {
      [90, 360, 920, 1800].forEach((ms) => {
        setTimeout(() => {
          autoClickEnableMusic();
          if (wantsMusic && bgm.paused) tryPlayMusic();
        }, ms);
      });
    }

    function enableSoundIfMuted() {
      if (bgm.paused || !bgm.muted) return;
      bgm.muted = false;
      startedMutedAutoplay = false;
      body.classList.remove("music-gesture");
      updateMusicBtn();
    }

    function toggleMusic() {
      if (!musicAvailable) return;
      if (bgm.paused) {
        wantsMusic = true;
        tryPlayMusic();
        return;
      }

      if (bgm.muted) {
        wantsMusic = true;
        enableSoundIfMuted();
        return;
      }

      wantsMusic = false;
      bgm.pause();
      bgm.muted = false;
      startedMutedAutoplay = false;
      body.classList.remove("music-gesture");
      updateMusicBtn();
    }

    bgm.volume = 0.48;
    bgm.autoplay = true;
    bgm.playsInline = true;
    bgm.addEventListener("error", () => {
      musicAvailable = false;
      wantsMusic = false;
      updateMusicBtn();
    });

    ["pointerdown", "touchstart", "keydown"].forEach((eventName) => {
      document.addEventListener(eventName, () => {
        ensureSfxReady();
        if (startedMutedAutoplay) enableSoundIfMuted();
        if (wantsMusic && bgm.paused) tryPlayMusic();
      });
    });

    if (isIOS) {
      const forceAudibleFromGesture = async () => {
        if (!wantsMusic || !musicAvailable) return;
        await ensureSfxReady();
        if (bgm.paused || bgm.muted) {
          bgm.muted = false;
          try {
            await bgm.play();
            startedMutedAutoplay = false;
            body.classList.remove("music-gesture");
            updateMusicBtn();
          } catch (_) {}
        }
      };

      ["touchstart", "touchend", "click"].forEach((eventName) => {
        document.addEventListener(eventName, forceAudibleFromGesture, { capture: true, passive: true });
      });
    }

    ["pageshow", "focus"].forEach((eventName) => {
      window.addEventListener(eventName, () => {
        if (wantsMusic && bgm.paused) tryPlayMusic();
      });
    });

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible" && wantsMusic && bgm.paused) {
        tryPlayMusic();
      }
    });

    replayBtn.addEventListener("click", () => {
      playStory();
      if (wantsMusic) {
        if (bgm.paused) {
          tryPlayMusic();
        } else {
          bgm.currentTime = 0;
          if (bgm.muted) body.classList.add("music-gesture");
        }
      }
    });

    musicBtn.addEventListener("click", toggleMusic);

    updateMusicBtn();
    playStory();
    tryPlayMusic();
    scheduleAutoplayRetries();
    scheduleAutoMusicButtonClicks();
  </script>
</body>
</html>
