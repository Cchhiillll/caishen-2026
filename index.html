<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Áå´Áå´Ë¥¢Á•ûÁôªÈó®</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&family=Long+Cang&display=swap" rel="stylesheet" />
  <style>
    :root {
      --red-1: #8f0f1d;
      --red-2: #c1192b;
      --red-3: #420610;
      --gold-1: #ffd256;
      --gold-2: #f1a80f;
      --ink: #251007;
      --ease-out: cubic-bezier(0.2, 0.75, 0.16, 1);
      --duilian-size: clamp(1.05rem, 2.35vw, 1.42rem);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      display: grid;
      place-items: center;
      overflow: hidden;
      color: #fff3c8;
      font-family: "ZCOOL QingKe HuangYou", "PingFang SC", sans-serif;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      background:
        radial-gradient(circle at 14% 8%, #ffe07d59 0%, transparent 26%),
        radial-gradient(circle at 86% 10%, #ffb14f4d 0%, transparent 24%),
        radial-gradient(circle at 50% 90%, #b80e2b35 0%, transparent 35%),
        linear-gradient(155deg, #290b2f 0%, var(--red-1) 38%, var(--red-3) 100%);
    }

    .festival {
      position: relative;
      width: min(1200px, 100vw);
      height: min(760px, 100vh);
      overflow: hidden;
      isolation: isolate;
    }

    .festival::before {
      content: "";
      position: absolute;
      inset: 10% 8%;
      background:
        radial-gradient(circle at center, #ffe27f4d 0%, transparent 58%),
        repeating-linear-gradient(30deg, #ffffff0a 0 10px, transparent 10px 20px);
      z-index: -1;
      opacity: 0.6;
    }

    img {
      -webkit-user-drag: none;
      user-drag: none;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }

    .title {
      position: absolute;
      top: calc(env(safe-area-inset-top, 0px) + 0.05%);
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-align: center;
      font-family: "Long Cang", cursive;
      font-size: clamp(2rem, 6.2vw, 4.8rem);
      letter-spacing: 0.05em;
      text-shadow: 0 0 22px #ffcf56b2;
      opacity: 0;
      transform: translateY(-16px);
      transition: 700ms var(--ease-out);
      z-index: 49;
      pointer-events: none;
    }

    body.phase-enter .title,
    body.phase-give .title {
      opacity: 1;
      transform: translateY(0);
    }

    .lantern {
      position: absolute;
      top: -8px;
      width: clamp(40px, 5vw, 62px);
      aspect-ratio: 0.78;
      border-radius: 50% 50% 44% 44%;
      background: linear-gradient(180deg, #ec3646, #8f0b1d);
      border: 3px solid #f0ba3a;
      box-shadow: inset 0 0 0 3px #f8d87947, 0 10px 18px #00000045;
      animation: sway var(--dur) ease-in-out infinite;
      transform-origin: top center;
    }

    .lantern::before {
      content: "";
      position: absolute;
      top: -24px;
      left: 50%;
      width: 2px;
      height: 24px;
      transform: translateX(-50%);
      background: #f4cd5d;
    }

    .lantern::after {
      content: "";
      position: absolute;
      bottom: -16px;
      left: 50%;
      width: 12px;
      height: 16px;
      transform: translateX(-50%);
      border-radius: 2px 2px 6px 6px;
      background: linear-gradient(180deg, #ffe898, #f0a91d);
    }

    .lantern.left {
      left: 6%;
      --dur: 3.8s;
    }

    .lantern.right {
      right: 6%;
      --dur: 4.2s;
    }

    .stage-shadow {
      position: absolute;
      left: 50%;
      bottom: 11%;
      width: min(920px, 94vw);
      height: clamp(82px, 12vw, 120px);
      transform: translateX(-50%);
      border-radius: 50%;
      background: radial-gradient(circle at center, #ffd76c4f, transparent 72%);
      filter: blur(2px);
    }

    .door-zone {
      position: absolute;
      left: 50%;
      bottom: 13%;
      width: min(50vw, 420px);
      height: min(70vw, 500px);
      transform: translateX(-50%);
      perspective: 1400px;
      z-index: 4;
    }

    .gate-crown {
      position: absolute;
      left: -10%;
      top: -18%;
      width: 120%;
      height: 22%;
      border-radius: 14px 14px 18px 18px;
      background: linear-gradient(180deg, #7a111f, #550a14);
      border: 5px solid #efbf53;
      box-shadow: 0 14px 24px #00000057, inset 0 0 0 3px #ffde8b30;
      display: grid;
      place-items: center;
      z-index: 9;
    }

    .gate-crown::before {
      content: "";
      position: absolute;
      inset: 10% 5%;
      border-radius: 10px 10px 16px 16px;
      border: 2px solid #ffd98a6e;
    }

    .gate-plaque {
      position: relative;
      z-index: 10;
      padding: 6px 18px;
      border: 2px solid #f6d17e;
      border-radius: 8px;
      color: #ffe9ad;
      background: linear-gradient(180deg, #d81a30, #9e1424);
      font-family: "Long Cang", cursive;
      letter-spacing: 0.08em;
      font-size: var(--duilian-size);
      text-shadow: 0 0 8px #00000088;
      box-shadow: inset 0 0 0 1px #ffefb233;
    }

    .gate-column {
      position: absolute;
      top: 8%;
      width: 12%;
      height: 96%;
      border-radius: 14px;
      border: 3px solid #e9b848;
      background:
        repeating-linear-gradient(
          180deg,
          #b9162a 0 18px,
          #921224 18px 36px
        );
      box-shadow: inset 0 0 0 2px #ffd76b4a;
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .gate-column.left {
      left: -11%;
    }

    .gate-column.right {
      right: -11%;
    }

    .couplet-text {
      writing-mode: vertical-rl;
      text-orientation: upright;
      letter-spacing: 0.18em;
      line-height: 1.1;
      font-family: "Long Cang", cursive;
      font-size: var(--duilian-size);
      color: #ffe8a5;
      text-shadow: 0 0 6px #300000cc;
      padding: 10px 4px;
      border-radius: 8px;
      border: 1px solid #f6c970;
      background: linear-gradient(180deg, #d81a30, #9e1424);
      box-shadow: inset 0 0 0 1px #ffefb233;
      z-index: 2;
      user-select: none;
    }

    .door-frame {
      position: absolute;
      inset: 6% 0 0;
      border: 12px solid var(--gold-2);
      border-radius: 16px;
      background: linear-gradient(180deg, #7c101f, #4f0a14);
      overflow: hidden;
      box-shadow: 0 18px 35px #0000005e, inset 0 0 0 7px #d83245;
      z-index: 3;
    }

    .door-frame::before {
      content: "";
      position: absolute;
      left: 50%;
      top: 0;
      width: 6px;
      height: 100%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, #ffd469, #bb7a0c);
      z-index: 2;
      opacity: 0.7;
    }

    .door {
      position: absolute;
      top: 0;
      width: 50%;
      height: 100%;
      border: 4px solid #efbf55;
      background: linear-gradient(180deg, #d02338, #881022);
      transition: transform 1200ms var(--ease-out);
      z-index: 3;
    }

    .door.left {
      left: 0;
      transform-origin: left center;
    }

    .door.right {
      right: 0;
      transform-origin: right center;
    }

    .door .label {
      position: absolute;
      inset: 13% 10%;
      border: 2px solid #ffe18d;
      border-radius: 8px;
      display: grid;
      place-items: center;
      color: #ffeaa3;
      font-size: clamp(1.1rem, 3vw, 1.8rem);
      text-shadow: 0 0 8px #00000066;
    }

    .door .ring {
      position: absolute;
      top: 50%;
      width: 18px;
      aspect-ratio: 1;
      border-radius: 50%;
      transform: translateY(-50%);
      background: radial-gradient(circle at 30% 28%, #fff3c0, #ca8208);
      box-shadow: 0 0 0 6px #996310;
    }

    .door.left .ring {
      right: 16%;
    }

    .door.right .ring {
      left: 16%;
    }

    .knock-line {
      position: absolute;
      left: 50%;
      bottom: calc(13% + min(70vw, 500px) + 16px);
      transform: translateX(-50%);
      padding: 9px 16px;
      border: 2px solid #ffe08a;
      border-radius: 999px;
      background: #37160fd9;
      letter-spacing: 0.12em;
      font-size: clamp(1rem, 2.4vw, 1.4rem);
      opacity: 0;
    }

    body.phase-knock .door-frame {
      animation: door-shake 0.46s ease-in-out 0s 4;
    }

    body.phase-knock .knock-line {
      opacity: 1;
      animation: echo 0.46s ease-in-out 0s 4;
    }

    body.phase-open .door.left,
    body.phase-enter .door.left,
    body.phase-give .door.left {
      transform: rotateY(-112deg);
    }

    body.phase-open .door.right,
    body.phase-enter .door.right,
    body.phase-give .door.right {
      transform: rotateY(112deg);
    }

    .cat-caishen {
      position: absolute;
      left: 50%;
      bottom: 12.5%;
      width: min(50vw, 560px);
      opacity: 0;
      transform: translate(-50%, 14%) scale(0.56);
      transform-origin: center bottom;
      transition: transform 1850ms var(--ease-out), opacity 720ms var(--ease-out);
      filter: drop-shadow(0 18px 24px #0000005d);
      z-index: 2;
    }

    body.phase-open .cat-caishen {
      opacity: 0.25;
      transform: translate(-50%, 11%) scale(0.62);
    }

    .cat-stage {
      width: 100%;
      filter: drop-shadow(0 14px 20px #00000066);
    }

    .cat-stage img {
      width: 100%;
      height: auto;
      display: block;
      animation: breathe 2.8s ease-in-out infinite;
    }

    body.phase-enter .cat-caishen,
    body.phase-give .cat-caishen {
      opacity: 1;
      transform: translate(-50%, 0) scale(1);
      z-index: 7;
    }

    .cat-caption {
      margin-top: 12px;
      text-align: center;
      font-size: clamp(0.95rem, 2vw, 1.25rem);
      color: #ffeeb2;
      text-shadow: 0 0 8px #4a0000;
    }

    .gift-tag {
      position: absolute;
      right: -8%;
      bottom: 20%;
      padding: 10px 16px;
      border-radius: 12px;
      border: 2px solid #a96a08;
      background: linear-gradient(180deg, #ffe18a, #f1aa16);
      color: #8a1313;
      font-size: clamp(1rem, 2vw, 1.2rem);
      box-shadow: 0 10px 16px #0000004f;
      opacity: 0;
      transform: translateY(10px) rotate(-6deg);
      transition: 500ms var(--ease-out);
    }

    body.phase-give .gift-tag {
      opacity: 1;
      transform: translateY(0) rotate(-6deg);
    }

    .rain-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .hongbao-rain {
      z-index: 45;
    }

    .yuanbao-rain {
      z-index: 44;
    }

    .hongbao-drop {
      position: absolute;
      top: -14%;
      left: var(--x);
      width: var(--w);
      height: calc(var(--w) * 1.22);
      border-radius: 8px;
      border: 2px solid #f5cf77;
      background:
        linear-gradient(180deg, #eb2c42 0%, #be152b 100%);
      box-shadow: 0 10px 14px #0000003a;
      animation: rain-fall var(--dur) linear forwards;
      transform: translate3d(0, -10vh, 0);
      will-change: transform;
      pointer-events: auto;
      cursor: pointer;
      touch-action: manipulation;
    }

    .hongbao-drop::before {
      content: "Á¶è";
      position: absolute;
      left: 50%;
      top: 50%;
      width: 58%;
      aspect-ratio: 1;
      transform: translate(-50%, -50%) rotate(45deg);
      border: 1px solid #ffebbd;
      background: #c8192f;
      color: #ffe8a5;
      display: grid;
      place-items: center;
      font-size: calc(var(--w) * 0.34);
      text-shadow: 0 0 8px #00000066;
    }

    .hongbao-drop.drop-tier-large {
      border-width: 3px;
      box-shadow: 0 12px 18px #00000049;
      filter: saturate(1.06) brightness(1.04);
    }

    .hongbao-drop.drop-tier-small {
      border-width: 1px;
      filter: saturate(0.95) brightness(0.96);
    }

    .yuanbao-drop {
      position: absolute;
      top: -12%;
      left: var(--x);
      width: var(--w);
      height: calc(var(--w) * 0.72);
      border-radius: 56% 56% 40% 40%;
      border: 2px solid #9d6107;
      background:
        linear-gradient(180deg, #ffe28b 0%, #f4b02d 58%, #df9300 100%);
      box-shadow: 0 9px 13px #00000042;
      animation: rain-fall var(--dur) linear forwards;
      transform: translate3d(0, -10vh, 0);
      will-change: transform;
      pointer-events: auto;
      cursor: pointer;
      touch-action: manipulation;
    }

    .yuanbao-drop.drop-tier-large {
      border-width: 3px;
      box-shadow: 0 11px 16px #0000004f;
      filter: saturate(1.07) brightness(1.06);
    }

    .yuanbao-drop.drop-tier-small {
      border-width: 1px;
      filter: saturate(0.92) brightness(0.95);
    }

    .drop-collected {
      pointer-events: none;
    }

    .drop-collected.hongbao-drop {
      animation: collect-hongbao 440ms ease-out forwards !important;
    }

    .drop-collected.yuanbao-drop {
      animation: collect-yuanbao 520ms ease-out forwards !important;
    }

    .yuanbao-drop::before {
      content: "";
      position: absolute;
      left: 50%;
      top: -32%;
      width: 46%;
      height: 40%;
      transform: translateX(-50%);
      border-radius: 50%;
      border: 2px solid #9d6107;
      background: linear-gradient(180deg, #ffe8a4, #efb53e);
    }

    .wish {
      position: absolute;
      left: 50%;
      bottom: 7%;
      transform: translateX(-50%) translateY(10px);
      width: min(92vw, 820px);
      text-align: center;
      font-size: clamp(1.3rem, 3.3vw, 2.05rem);
      text-shadow: 0 0 14px #851500;
      opacity: 0;
      transition: 800ms var(--ease-out);
    }

    body.phase-give .wish {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .score-board {
      position: absolute;
      left: min(4vw, 22px);
      top: calc(env(safe-area-inset-top, 0px) + min(1.8vw, 12px));
      padding: 8px 12px;
      border-radius: 12px;
      border: 2px solid #ffd777;
      background: #4b130fd9;
      color: #ffe9a7;
      font-size: clamp(0.88rem, 1.7vw, 1.02rem);
      letter-spacing: 0.04em;
      text-shadow: 0 0 6px #3a1200;
      white-space: nowrap;
      z-index: 48;
      pointer-events: none;
    }

    .countdown-board {
      padding: 10px 14px;
      margin-top: 8px;
      border-radius: 12px;
      border: 2px solid #ffd777;
      background: #611515e8;
      color: #ffe9a7;
      font-size: clamp(0.96rem, 2vw, 1.18rem);
      letter-spacing: 0.05em;
      white-space: nowrap;
      text-shadow: 0 0 8px #4a0f00;
      pointer-events: none;
    }

    .score-pop {
      position: fixed;
      left: 0;
      top: 0;
      transform: translate(-50%, -50%);
      color: #ffe37f;
      font-size: 1.05rem;
      letter-spacing: 0.02em;
      text-shadow: 0 0 10px #8a2a00;
      pointer-events: none;
      z-index: 60;
      animation: score-pop 700ms ease-out forwards;
      white-space: nowrap;
    }

    .score-pop.yuanbao {
      color: #ffefb5;
      text-shadow: 0 0 10px #ac6c00;
    }

    .action-stack {
      position: absolute;
      right: min(4vw, 22px);
      bottom: min(4vw, 20px);
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
      z-index: 50;
    }

    .controls {
      display: none;
    }

    .music-icon-btn {
      position: absolute;
      right: min(4vw, 22px);
      top: calc(env(safe-area-inset-top, 0px) + min(1.8vw, 12px));
      width: 46px;
      height: 46px;
      border: 2px solid #ffd778;
      border-radius: 50%;
      background: #4a1020e6;
      color: #ffedb6;
      font-size: 1.35rem;
      line-height: 1;
      display: grid;
      place-items: center;
      cursor: pointer;
      z-index: 50;
      box-shadow: 0 8px 14px #00000044;
      transition: 200ms ease;
      touch-action: manipulation;
    }

    .music-icon-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      background: #6b1830;
    }

    .music-icon-btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .btn {
      border: 2px solid #ffde82;
      border-radius: 12px;
      padding: 10px 14px;
      background: #4a1020de;
      color: #ffedb6;
      font-family: inherit;
      font-size: 1rem;
      cursor: pointer;
      transition: 220ms ease;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      background: #6b1830;
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .music-hint {
      position: absolute;
      left: 50%;
      top: 12%;
      transform: translateX(-50%);
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #ffd86c;
      background: #2b1109de;
      color: #ffecae;
      opacity: 0;
      transition: 260ms ease;
      pointer-events: none;
    }

    body.music-gesture .music-hint {
      opacity: 1;
    }

    .credit {
      position: fixed;
      left: 50%;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 8px);
      transform: translateX(-50%);
      font-size: clamp(0.72rem, 1.7vw, 0.9rem);
      letter-spacing: 0.04em;
      color: #ffe7a6cc;
      text-shadow: 0 0 6px #4a1000a8;
      z-index: 40;
      pointer-events: none;
      white-space: nowrap;
    }

    .share-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: #1a060acc;
      backdrop-filter: blur(3px);
      z-index: 80;
    }

    .share-modal.open {
      display: flex;
    }

    .share-dialog {
      width: min(92vw, 560px);
      border-radius: 18px;
      border: 2px solid #ffd777;
      padding: 16px;
      background:
        radial-gradient(circle at 14% 12%, #ffd88461 0%, transparent 30%),
        radial-gradient(circle at 85% 88%, #f9c84f2e 0%, transparent 34%),
        linear-gradient(150deg, #7e0f1f 0%, #4c0a15 100%);
      box-shadow: 0 22px 38px #00000066;
      color: #ffefbf;
      text-align: center;
    }

    .share-title {
      font-size: clamp(1.3rem, 3.8vw, 1.8rem);
      color: #ffe8a0;
      text-shadow: 0 0 10px #6e0a09;
    }

    .share-subtitle {
      margin-top: 8px;
      color: #ffe5a6;
      font-size: clamp(0.94rem, 2.6vw, 1.05rem);
    }

    .share-actions {
      margin-top: 12px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .share-card {
      width: min(84vw, 420px);
      margin: 14px auto 0;
      border-radius: 26px;
      border: 3px solid #f7d27a;
      background:
        radial-gradient(circle at 14% 10%, #f4d16f4a 0%, transparent 34%),
        radial-gradient(circle at 88% 92%, #ffdc7540 0%, transparent 40%),
        repeating-linear-gradient(32deg, #ffffff0d 0 11px, transparent 11px 24px),
        linear-gradient(166deg, #a1082a 0%, #79051f 100%);
      padding: 24px 22px 26px;
      text-align: center;
      box-shadow:
        inset 0 0 0 1px #ffefb261,
        0 16px 28px #20010666;
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .share-card::before,
    .share-card::after {
      content: "";
      position: absolute;
      pointer-events: none;
      z-index: -1;
    }

    .share-card::before {
      inset: 12px;
      border-radius: 20px;
      border: 2px solid #f6d386;
      opacity: 0.68;
    }

    .share-card::after {
      width: 170px;
      height: 170px;
      right: -52px;
      top: -52px;
      border-radius: 50%;
      background: radial-gradient(circle, #ffecb573 0%, #ffecb500 68%);
    }

    .share-card-title {
      font-size: clamp(1.5rem, 4.2vw, 2.1rem);
      letter-spacing: 0.04em;
      color: #ffefbd;
      text-shadow: 0 2px 12px #5b0402;
      line-height: 1.2;
    }

    .share-card-subtitle {
      margin-top: 8px;
      color: #ffe3a6;
      font-size: clamp(0.95rem, 2.5vw, 1.06rem);
      letter-spacing: 0.02em;
    }

    .share-card-stats {
      margin-top: 16px;
      border-radius: 16px;
      border: 2px solid #f2ca73;
      background: #b54f4d5e;
      box-shadow: inset 0 0 0 1px #fff0bf42;
      padding: 14px 12px;
    }

    .share-card-score {
      color: #ffecb3;
      font-size: clamp(1.3rem, 3.8vw, 1.8rem);
      line-height: 1.3;
      font-weight: 700;
      text-shadow: 0 0 10px #6b0404;
    }

    .share-card-counts {
      margin-top: 6px;
      color: #ffeab7;
      font-size: clamp(1rem, 2.7vw, 1.18rem);
      letter-spacing: 0.02em;
    }

    .share-card-qr {
      margin: 18px auto 0;
      width: min(48vw, 220px);
      max-width: 220px;
      border-radius: 16px;
      border: 4px solid #f6d58b;
      background: #fff7dc;
      padding: 8px;
      display: block;
    }

    .share-card-note {
      margin-top: 12px;
      color: #ffe8b3;
      font-size: clamp(0.95rem, 2.5vw, 1.06rem);
      letter-spacing: 0.02em;
    }

    .share-card-link {
      margin-top: 4px;
      color: #ffdd9a;
      font-size: clamp(0.9rem, 2.3vw, 1.01rem);
    }

    .share-card-brand {
      margin-top: 14px;
      color: #ffd992;
      font-size: clamp(0.86rem, 2.1vw, 0.96rem);
    }

    .save-toast {
      position: fixed;
      left: 50%;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 26px);
      transform: translateX(-50%) translateY(10px);
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid #ffd777;
      background: #3f0f14e6;
      color: #ffeab4;
      font-size: clamp(0.86rem, 2.3vw, 1rem);
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      z-index: 90;
      transition: 220ms ease;
      text-shadow: 0 0 8px #4a1000;
    }

    .save-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    @keyframes door-shake {
      0%, 100% { transform: translateX(0); }
      30% { transform: translateX(-4px); }
      70% { transform: translateX(4px); }
    }

    @keyframes echo {
      0%, 100% { transform: translateX(-50%) scale(1); }
      45% { transform: translateX(-50%) scale(1.06); }
    }

    @keyframes rain-fall {
      0% {
        transform: translate3d(0, -10vh, 0) rotate(var(--r0));
        opacity: 0.05;
      }
      12% {
        opacity: 1;
      }
      100% {
        transform: translate3d(var(--drift), 120vh, 0) rotate(var(--r1));
        opacity: 0.95;
      }
    }

    @keyframes sway {
      0%, 100% { transform: rotate(-3deg); }
      50% { transform: rotate(3deg); }
    }

    @keyframes breathe {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }

    @keyframes collect-hongbao {
      0% { opacity: 1; transform: scale(1) rotate(0deg); }
      60% { opacity: 1; transform: scale(1.26) rotate(16deg); }
      100% { opacity: 0; transform: scale(0.22) rotate(34deg); }
    }

    @keyframes collect-yuanbao {
      0% { opacity: 1; transform: scale(1) rotate(0deg); }
      45% { opacity: 1; transform: scale(1.24) rotate(-10deg); }
      100% { opacity: 0; transform: scale(0.2) rotate(-22deg); }
    }

    @keyframes score-pop {
      0% { opacity: 0; transform: translate(-50%, -40%) scale(0.68); }
      16% { opacity: 1; transform: translate(-50%, -52%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -178%) scale(1.06); }
    }

    @media (max-width: 960px) {
      .door-zone {
        left: 50%;
        width: min(52vw, 390px);
      }

      .cat-caishen {
        width: min(52vw, 480px);
        bottom: 14%;
      }

      body.phase-enter .cat-caishen,
      body.phase-give .cat-caishen {
        transform: translate(-50%, 0) scale(1);
      }
    }

    @media (max-width: 760px) {
      .festival {
        height: 100vh;
      }

      .title {
        top: calc(env(safe-area-inset-top, 0px) + 0%);
        font-size: clamp(1.45rem, 6.6vw, 2.6rem);
        letter-spacing: 0.03em;
      }

      .door-zone {
        left: 50%;
        right: auto;
        bottom: 24%;
        width: min(62vw, 320px);
        height: min(84vw, 440px);
        transform: translateX(-50%);
      }

      .knock-line {
        bottom: calc(24% + min(84vw, 440px) + 12px);
      }

      .cat-caishen {
        width: min(76vw, 405px);
        bottom: 30%;
        transform: translate(-50%, 14%) scale(0.52);
      }

      body.phase-open .cat-caishen {
        transform: translate(-50%, 12%) scale(0.58);
      }

      body.phase-enter .cat-caishen,
      body.phase-give .cat-caishen {
        transform: translate(-50%, 0) scale(0.94);
      }

      .cat-caption {
        font-size: 1rem;
      }

      .gate-plaque,
      .couplet-text {
        font-size: clamp(1rem, 3.15vw, 1.2rem);
      }

      .couplet-text {
        letter-spacing: 0.16em;
      }

      .action-stack {
        bottom: calc(env(safe-area-inset-bottom, 0px) + 76px);
      }

      .score-board {
        top: calc(env(safe-area-inset-top, 0px) + 56px);
        font-size: 0.86rem;
        padding: 7px 10px;
      }

      .countdown-board {
        font-size: 1rem;
      }

      .music-icon-btn {
        top: calc(env(safe-area-inset-top, 0px) + 8px);
        width: 42px;
        height: 42px;
        font-size: 1.2rem;
      }

      .wish {
        bottom: calc(env(safe-area-inset-bottom, 0px) + 30px);
        font-size: clamp(1rem, 3.8vw, 1.22rem);
      }
    }

    @media (max-width: 520px) {
      .festival {
        min-height: 100vh;
      }

      .title {
        top: calc(env(safe-area-inset-top, 0px) + 0%);
        font-size: clamp(1.2rem, 6.2vw, 1.82rem);
        letter-spacing: 0.01em;
      }

      .door-zone {
        left: 50%;
        right: auto;
        bottom: 21%;
        width: min(64vw, 300px);
        height: min(88vw, 430px);
        transform: translateX(-50%);
      }

      .knock-line {
        bottom: calc(21% + min(88vw, 430px) + 10px);
      }

      .cat-caishen {
        width: min(82vw, 360px);
        bottom: 33%;
        transform: translate(-50%, 14%) scale(0.49);
      }

      body.phase-open .cat-caishen {
        transform: translate(-50%, 12%) scale(0.56);
      }

      body.phase-enter .cat-caishen,
      body.phase-give .cat-caishen {
        transform: translate(-50%, 0) scale(0.9);
      }

      .action-stack {
        left: 50%;
        right: auto;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 104px);
        transform: translateX(-50%);
        align-items: center;
      }

      .score-board {
        left: 50%;
        top: calc(env(safe-area-inset-top, 0px) + 62px);
        transform: translateX(-50%);
        font-size: 0.8rem;
        padding: 7px 10px;
      }

      .countdown-board {
        font-size: 0.94rem;
      }

      .music-icon-btn {
        top: calc(env(safe-area-inset-top, 0px) + 8px);
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
      }

      .wish {
        bottom: calc(env(safe-area-inset-bottom, 0px) + 26px);
        font-size: clamp(0.94rem, 4.7vw, 1.16rem);
      }

      .gate-column {
        width: 13%;
      }

      .gate-plaque,
      .couplet-text {
        font-size: 0.96rem;
      }

      .couplet-text {
        padding: 8px 3px;
      }
    }
  </style>
</head>
<body>
  <main class="festival">
    <h1 class="title">Âàù‰∫îËøéË¥¢Á•û ÂÖ´ÊñπÊù•Ë¥¢</h1>

    <span class="lantern left"></span>
    <span class="lantern right"></span>
    <div class="stage-shadow"></div>

    <section class="door-zone" aria-label="Â§ßÈó®">
      <div class="gate-crown">
        <span class="gate-plaque">Ë¥¢Ëøê‰∫®ÈÄö</span>
      </div>
      <span class="gate-column left">
        <span class="couplet-text">Á•û‰ΩëÂÖ´ÊñπÂà©‰ººÊò•</span>
      </span>
      <span class="gate-column right">
        <span class="couplet-text">È©¨Â•îÂõõÊµ∑Ë¥¢Â¶ÇÊ∞¥</span>
      </span>
      <div class="door-frame">
        <div class="door left">
          <div class="label">ÊãõË¥¢</div>
          <span class="ring"></span>
        </div>
        <div class="door right">
          <div class="label">ËøõÂÆù</div>
          <span class="ring"></span>
        </div>
      </div>
    </section>

    <p class="knock-line">ÂíöÂíöÂíöÔºåÁå´Áå´Ë¥¢Á•ûÂà∞</p>

    <figure class="cat-caishen">
      <div class="cat-stage">
        <img src="assets/cat-caishen.png" alt="‰∏§Âè™Áå´Ë¥¢Á•ûÂõæ" />
      </div>
      <figcaption class="cat-caption">‰∏§‰ΩçË¥¢Á•ûÁå´ËøõÈó®ÈÄÅÁ¶è</figcaption>
    </figure>

    <div class="rain-layer yuanbao-rain" id="yuanbaoRain"></div>
    <div class="rain-layer hongbao-rain" id="hongbaoRain"></div>
    <p class="wish">ÂñµË¥¢Á•ûËøõÈó®ÔºåÂÖ´ÊñπÊù•Ë¥¢ÔºåÈáëÈì∂Êª°‰ªìÔºÅ</p>
    <p class="score-board" id="scoreBoard">Á∫¢ÂåÖ 0 ¬∑ ÂÖÉÂÆù 0 ¬∑ Ë¥¢ËøêÂÄº 0</p>
    <button class="music-icon-btn" id="musicBtn" type="button" aria-label="ÂÖ≥Èó≠Èü≥‰πê" title="ÂÖ≥Èó≠Èü≥‰πê">üîä</button>

    <p class="music-hint">Â∑≤Ëá™Âä®Êí≠ÊîæÔºåiPhone ËΩªËß¶È°µÈù¢ÂèØÁ´ãÂç≥ÂºÄÂ£∞</p>

    <div class="action-stack">
      <div class="controls">
        <button class="btn" id="replayBtn" type="button">ÂÜçËøé‰∏ÄÊ¨°</button>
      </div>
      <p class="countdown-board" id="countdownBoard">Êä¢Á∫¢ÂåÖÂÄíËÆ°Êó∂ 15s</p>
    </div>
  </main>
  <section class="share-modal" id="shareModal" aria-hidden="true">
    <div class="share-dialog" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
      <h2 class="share-title" id="shareTitle">15ÁßíÂà∞ÔºåË¥¢ËøêÊ≠£Êó∫</h2>
      <p class="share-subtitle" id="shareSummary">Êù•ÁîüÊàêÂñúÂ∫ÜÂàÜ‰∫´Âç°ÔºåÊôíÂá∫‰Ω†ÁöÑËøéË¥¢Á•ûÊàòÁª©„ÄÇ</p>
      <div class="share-actions">
        <button class="btn" id="genShareCardBtn" type="button">‰∏ãËΩΩÂàÜ‰∫´Âç°Áâá</button>
        <button class="btn" id="closeShareModalBtn" type="button">ÁªßÁª≠Êä¢Á¶èÊ∞î</button>
      </div>
      <article class="share-card" id="shareCard" hidden>
        <h3 class="share-card-title">Âàù‰∫îËøéË¥¢Á•û ¬∑ ÂÖ´ÊñπÊù•Ë¥¢</h3>
        <p class="share-card-subtitle">ÂñµË¥¢Á•ûËøõÈó®ÔºåÁ¶èÊ∞îÊª°‰ªì</p>
        <div class="share-card-stats">
          <p class="share-card-score" id="shareCardScore">Ë¥¢ËøêÂÄº 0</p>
          <p class="share-card-counts" id="shareCardCounts">Á∫¢ÂåÖ 0 ‰∏™ ¬∑ ÂÖÉÂÆù 0 ‰∏™</p>
        </div>
        <img class="share-card-qr" id="shareCardQr" alt="caishen.wypchill.work ‰∫åÁª¥Á†Å" />
        <p class="share-card-note">Êâ´Á†ÅËøéÊé•‰Ω†ÁöÑË¥¢Á•ûÔºåÊèêÂçáË¥¢ËøêÂÄº</p>
        <p class="share-card-link">caishen.wypchill.work</p>
        <p class="share-card-brand">chillwangÁöÑAIÊó†ÈôêÂÖ¨Âè∏Âá∫ÂìÅ</p>
      </article>
    </div>
  </section>
  <p class="save-toast" id="saveToast" role="status" aria-live="polite"></p>
  <p class="credit">chillwangÁöÑAIÊó†ÈôêÂÖ¨Âè∏Âá∫ÂìÅ</p>

  <audio id="bgm" preload="auto" loop autoplay playsinline webkit-playsinline x5-playsinline>
    <source src="assets/bafanglaicai.mp3" type="audio/mpeg" />
  </audio>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    const phases = ["phase-knock", "phase-open", "phase-enter", "phase-give"];
    const phaseTimes = [0, 1700, 2800, 4300];
    const timers = [];
    const body = document.body;

    const replayBtn = document.getElementById("replayBtn");
    const musicBtn = document.getElementById("musicBtn");
    const countdownBoard = document.getElementById("countdownBoard");
    const hongbaoRain = document.getElementById("hongbaoRain");
    const yuanbaoRain = document.getElementById("yuanbaoRain");
    const shareModal = document.getElementById("shareModal");
    const shareTitle = document.getElementById("shareTitle");
    const shareSummary = document.getElementById("shareSummary");
    const genShareCardBtn = document.getElementById("genShareCardBtn");
    const closeShareModalBtn = document.getElementById("closeShareModalBtn");
    const shareCard = document.getElementById("shareCard");
    const shareCardScore = document.getElementById("shareCardScore");
    const shareCardCounts = document.getElementById("shareCardCounts");
    const shareCardQr = document.getElementById("shareCardQr");
    const saveToast = document.getElementById("saveToast");
    const bgm = document.getElementById("bgm");
    const isIOS = /iP(hone|ad|od)/.test(navigator.userAgent)
      || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

    let wantsMusic = true;
    let musicAvailable = true;
    let audioCtx = null;
    let rainRunning = false;
    let hongbaoTimer = null;
    let yuanbaoTimer = null;
    let startedMutedAutoplay = false;
    let hongbaoCount = 0;
    let yuanbaoCount = 0;
    let fortuneTotal = 0;
    let lastHapticAt = 0;
    const ROUND_SECONDS = 15;
    let countdownLeft = ROUND_SECONDS;
    let countdownTimer = null;
    let shareReminderShown = false;
    let saveToastTimer = null;
    const SHARE_URL = "https://caishen.wypchill.work";
    const SHARE_QR_URL = `https://api.qrserver.com/v1/create-qr-code/?size=480x480&margin=0&data=${encodeURIComponent(SHARE_URL)}`;
    const HONGBAO_DROP_TYPES = [
      { tier: "large", weight: 15, points: 688, width: [36, 52] },
      { tier: "medium", weight: 20, points: 168, width: [28, 40] },
      { tier: "small", weight: 30, points: 6, width: [20, 30] }
    ];
    const YUANBAO_DROP_TYPES = [
      { tier: "large", weight: 5, points: 888, width: [40, 56] },
      { tier: "medium", weight: 15, points: 188, width: [30, 44] },
      { tier: "small", weight: 25, points: 88, width: [22, 32] }
    ];

    function randInt(min, max) {
      return min + Math.floor(Math.random() * (max - min + 1));
    }

    function pickWeightedType(pool) {
      const total = pool.reduce((sum, item) => sum + item.weight, 0);
      let roll = Math.random() * total;
      for (const item of pool) {
        roll -= item.weight;
        if (roll <= 0) return item;
      }
      return pool[pool.length - 1];
    }

    function updateScoreBoard() {
      const scoreBoard = document.getElementById("scoreBoard");
      scoreBoard.textContent = `Á∫¢ÂåÖ ${hongbaoCount} ¬∑ ÂÖÉÂÆù ${yuanbaoCount} ¬∑ Ë¥¢ËøêÂÄº ${fortuneTotal.toLocaleString("zh-CN")}`;
    }

    function updateCountdownBoard() {
      countdownBoard.textContent = `Êä¢Á∫¢ÂåÖÂÄíËÆ°Êó∂ ${Math.max(0, countdownLeft)}s`;
    }

    function stopCountdown() {
      if (!countdownTimer) return;
      clearInterval(countdownTimer);
      countdownTimer = null;
    }

    function setShareModalOpen(open) {
      shareModal.classList.toggle("open", open);
      shareModal.setAttribute("aria-hidden", open ? "false" : "true");
      if (!open) shareCard.hidden = true;
    }

    function buildShareSummaryText() {
      return `Êú¨ËΩÆ${ROUND_SECONDS}ÁßíÔºöÁ∫¢ÂåÖ ${hongbaoCount} ‰∏™ÔºåÂÖÉÂÆù ${yuanbaoCount} ‰∏™ÔºåË¥¢ËøêÂÄº ${fortuneTotal.toLocaleString("zh-CN")}„ÄÇ`;
    }

    function openShareReminder() {
      shareTitle.textContent = `${ROUND_SECONDS}ÁßíÂà∞ÔºåË¥¢ËøêÊ≠£Êó∫`;
      shareSummary.textContent = `${buildShareSummaryText()} ÁÇπÂáª‰∏ãÊñπ‰∏ãËΩΩÂñúÂ∫ÜÂàÜ‰∫´Âç°„ÄÇ`;
      setShareModalOpen(true);
    }

    function startCountdown() {
      if (countdownTimer) return;
      countdownLeft = ROUND_SECONDS;
      shareReminderShown = false;
      updateCountdownBoard();
      countdownTimer = setInterval(() => {
        countdownLeft -= 1;
        updateCountdownBoard();
        if (countdownLeft > 0) return;
        stopCountdown();
        if (shareReminderShown) return;
        shareReminderShown = true;
        openShareReminder();
      }, 1000);
    }

    function buildShareCard() {
      shareCardScore.textContent = `Ë¥¢ËøêÂÄº ${fortuneTotal.toLocaleString("zh-CN")}`;
      shareCardCounts.textContent = `Á∫¢ÂåÖ ${hongbaoCount} ‰∏™ ¬∑ ÂÖÉÂÆù ${yuanbaoCount} ‰∏™`;
      shareCardQr.crossOrigin = "anonymous";
      if (shareCardQr.src !== SHARE_QR_URL) {
        shareCardQr.src = SHARE_QR_URL;
      }
      shareCard.hidden = false;
    }

    function showSaveToast(message) {
      saveToast.textContent = message;
      saveToast.classList.add("show");
      if (saveToastTimer) clearTimeout(saveToastTimer);
      saveToastTimer = setTimeout(() => {
        saveToast.classList.remove("show");
      }, 1800);
    }

    function nextFrame() {
      return new Promise((resolve) => requestAnimationFrame(resolve));
    }

    function waitImageReady(img) {
      return new Promise((resolve, reject) => {
        if (img.complete && img.naturalWidth > 0) {
          resolve();
          return;
        }
        const onLoad = () => {
          img.removeEventListener("load", onLoad);
          img.removeEventListener("error", onError);
          resolve();
        };
        const onError = () => {
          img.removeEventListener("load", onLoad);
          img.removeEventListener("error", onError);
          reject(new Error("share qr image load failed"));
        };
        img.addEventListener("load", onLoad, { once: true });
        img.addEventListener("error", onError, { once: true });
      });
    }

    async function renderShareCardBlobFromDom() {
      if (typeof window.html2canvas !== "function") {
        throw new Error("html2canvas unavailable");
      }

      buildShareCard();
      await nextFrame();
      await nextFrame();
      if (document.fonts && document.fonts.ready) {
        try {
          await document.fonts.ready;
        } catch (_) {}
      }
      await waitImageReady(shareCardQr);

      const canvas = await window.html2canvas(shareCard, {
        backgroundColor: null,
        useCORS: true,
        logging: false,
        scale: Math.max(2, window.devicePixelRatio || 1)
      });

      return new Promise((resolve, reject) => {
        canvas.toBlob((blob) => {
          if (!blob) {
            reject(new Error("share card toBlob failed"));
            return;
          }
          resolve(blob);
        }, "image/png");
      });
    }

    async function downloadShareCard() {
      buildShareCard();
      const originalText = genShareCardBtn.textContent;
      genShareCardBtn.disabled = true;
      genShareCardBtn.textContent = "‰∏ãËΩΩ‰∏≠...";
      try {
        const blob = await renderShareCardBlobFromDom();
        const stamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, "-");
        const filename = `ËøéË¥¢Á•ûÂàÜ‰∫´Âç°-${stamp}.png`;

        const shareWithFile = navigator.share && navigator.canShare && (() => {
          try {
            const file = new File([blob], filename, { type: "image/png" });
            return navigator.canShare({ files: [file] }) ? file : null;
          } catch (_) {
            return null;
          }
        })();

        if (shareWithFile) {
          await navigator.share({
            files: [shareWithFile],
            title: "ËøéË¥¢Á•ûÂàÜ‰∫´Âç°",
            text: "Âàù‰∫îËøéË¥¢Á•ûÔºåÂÖ´ÊñπÊù•Ë¥¢"
          });
          genShareCardBtn.textContent = "Â∑≤‰øùÂ≠ò";
          showSaveToast("Â∑≤‰øùÂ≠òdioxinÁõ∏ÂÜå");
        } else {
          const objectUrl = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = objectUrl;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          link.remove();
          setTimeout(() => URL.revokeObjectURL(objectUrl), 1200);
          genShareCardBtn.textContent = "Â∑≤‰øùÂ≠ò";
          showSaveToast("Â∑≤‰øùÂ≠òdioxinÁõ∏ÂÜå");
        }
      } catch (_) {
        genShareCardBtn.textContent = "‰∏ãËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï";
      } finally {
        setTimeout(() => {
          genShareCardBtn.disabled = false;
          genShareCardBtn.textContent = originalText;
        }, 1100);
      }
    }

    function showScorePop(x, y, text, kind) {
      const pop = document.createElement("span");
      pop.className = `score-pop${kind === "yuanbao" ? " yuanbao" : ""}`;
      pop.textContent = text;
      pop.style.left = `${x}px`;
      pop.style.top = `${y}px`;
      document.body.appendChild(pop);
      pop.addEventListener("animationend", () => pop.remove(), { once: true });
    }

    function triggerHaptic(kind) {
      if (kind !== "hongbao") return;
      if (!navigator.vibrate) return;
      const now = typeof performance !== "undefined" ? performance.now() : Date.now();
      if (now - lastHapticAt < 55) return;
      lastHapticAt = now;
      try {
        navigator.vibrate(18);
      } catch (_) {}
    }

    function collectDrop(dropEl, kind, event) {
      if (!dropEl || dropEl.classList.contains("drop-collected")) return;
      dropEl.classList.add("drop-collected");

      const parsedPoints = Number(dropEl.dataset.points);
      let added = Number.isFinite(parsedPoints) && parsedPoints > 0
        ? parsedPoints
        : (kind === "yuanbao" ? 188 : 88);
      if (kind === "yuanbao") {
        yuanbaoCount += 1;
      } else {
        hongbaoCount += 1;
      }

      fortuneTotal += added;
      updateScoreBoard();

      const x = event && typeof event.clientX === "number" ? event.clientX : window.innerWidth / 2;
      const y = event && typeof event.clientY === "number" ? event.clientY : window.innerHeight / 2;
      showScorePop(x, y, `+${added}`, kind);
      triggerHaptic(kind);
      dropEl.addEventListener("animationend", () => dropEl.remove(), { once: true });
    }

    function pickDropAtPoint(x, y) {
      const candidates = typeof document.elementsFromPoint === "function"
        ? document.elementsFromPoint(x, y)
        : [document.elementFromPoint(x, y)];
      for (const el of candidates) {
        if (!el || !el.classList) continue;
        if (el.classList.contains("hongbao-drop") || el.classList.contains("yuanbao-drop")) {
          return el;
        }
      }
      return null;
    }

    function collectByTouchPoints(touches) {
      const touched = new Set();
      for (const touch of touches) {
        const el = pickDropAtPoint(touch.clientX, touch.clientY);
        if (!el || touched.has(el)) continue;
        touched.add(el);
        const kind = el.classList.contains("yuanbao-drop") ? "yuanbao" : "hongbao";
        collectDrop(el, kind, { clientX: touch.clientX, clientY: touch.clientY });
      }
      return touched.size > 0;
    }

    function clearStory() {
      phases.forEach((name) => body.classList.remove(name));
      while (timers.length) {
        clearTimeout(timers.pop());
      }
      stopCountdown();
      setShareModalOpen(false);
      countdownLeft = ROUND_SECONDS;
      updateCountdownBoard();
      stopRains();
    }

    function stopRains() {
      rainRunning = false;
      if (hongbaoTimer) {
        clearInterval(hongbaoTimer);
        hongbaoTimer = null;
      }
      if (yuanbaoTimer) {
        clearInterval(yuanbaoTimer);
        yuanbaoTimer = null;
      }
      hongbaoRain.innerHTML = "";
      yuanbaoRain.innerHTML = "";
    }

    function spawnHongbaoDrop() {
      if (!rainRunning) return;
      const packet = document.createElement("span");
      const spec = pickWeightedType(HONGBAO_DROP_TYPES);
      const w = randInt(spec.width[0], spec.width[1]);
      packet.className = `hongbao-drop drop-tier-${spec.tier}`;
      packet.dataset.points = String(spec.points);
      packet.style.setProperty("--x", `${4 + Math.random() * 92}%`);
      packet.style.setProperty("--w", `${w}px`);
      packet.style.setProperty("--dur", `${4100 + Math.floor(Math.random() * 2400)}ms`);
      packet.style.setProperty("--drift", `${-85 + Math.floor(Math.random() * 170)}px`);
      packet.style.setProperty("--r0", `${-50 + Math.floor(Math.random() * 100)}deg`);
      packet.style.setProperty("--r1", `${-500 + Math.floor(Math.random() * 1000)}deg`);
      packet.addEventListener("pointerdown", (event) => {
        if (event.pointerType === "touch") return;
        event.preventDefault();
        collectDrop(packet, "hongbao", event);
      });
      packet.addEventListener("animationend", () => packet.remove(), { once: true });
      hongbaoRain.appendChild(packet);
    }

    function spawnYuanbaoDrop() {
      if (!rainRunning) return;
      const ingot = document.createElement("span");
      const spec = pickWeightedType(YUANBAO_DROP_TYPES);
      const w = randInt(spec.width[0], spec.width[1]);
      ingot.className = `yuanbao-drop drop-tier-${spec.tier}`;
      ingot.dataset.points = String(spec.points);
      ingot.style.setProperty("--x", `${6 + Math.random() * 88}%`);
      ingot.style.setProperty("--w", `${w}px`);
      ingot.style.setProperty("--dur", `${4600 + Math.floor(Math.random() * 2600)}ms`);
      ingot.style.setProperty("--drift", `${-60 + Math.floor(Math.random() * 120)}px`);
      ingot.style.setProperty("--r0", `${-26 + Math.floor(Math.random() * 52)}deg`);
      ingot.style.setProperty("--r1", `${-240 + Math.floor(Math.random() * 480)}deg`);
      ingot.addEventListener("pointerdown", (event) => {
        if (event.pointerType === "touch") return;
        event.preventDefault();
        collectDrop(ingot, "yuanbao", event);
      });
      ingot.addEventListener("animationend", () => ingot.remove(), { once: true });
      yuanbaoRain.appendChild(ingot);
    }

    function startRains() {
      if (rainRunning) return;
      rainRunning = true;

      for (let i = 0; i < 16; i += 1) {
        setTimeout(() => spawnHongbaoDrop(), i * 70);
      }
      for (let i = 0; i < 10; i += 1) {
        setTimeout(() => spawnYuanbaoDrop(), i * 90);
      }

      hongbaoTimer = setInterval(() => {
        const burst = 1 + Math.floor(Math.random() * 3);
        for (let i = 0; i < burst; i += 1) spawnHongbaoDrop();
      }, 170);

      yuanbaoTimer = setInterval(() => {
        const burst = Math.random() < 0.72 ? 1 : 2;
        for (let i = 0; i < burst; i += 1) spawnYuanbaoDrop();
      }, 280);
    }

    async function ensureSfxReady() {
      const AudioContextCtor = window.AudioContext || window.webkitAudioContext;
      if (!AudioContextCtor) return false;
      if (!audioCtx) audioCtx = new AudioContextCtor();
      if (audioCtx.state === "suspended") {
        try {
          await audioCtx.resume();
        } catch (_) {
          return false;
        }
      }
      return audioCtx.state === "running";
    }

    function playKnockHit(offsetSec) {
      if (!audioCtx) return;
      const at = audioCtx.currentTime + offsetSec;

      const tone = audioCtx.createOscillator();
      tone.type = "triangle";
      tone.frequency.setValueAtTime(185, at);
      tone.frequency.exponentialRampToValueAtTime(82, at + 0.16);

      const toneGain = audioCtx.createGain();
      toneGain.gain.setValueAtTime(0.0001, at);
      toneGain.gain.exponentialRampToValueAtTime(0.12, at + 0.012);
      toneGain.gain.exponentialRampToValueAtTime(0.0001, at + 0.18);

      const noiseBuffer = audioCtx.createBuffer(1, Math.floor(audioCtx.sampleRate * 0.09), audioCtx.sampleRate);
      const channel = noiseBuffer.getChannelData(0);
      for (let i = 0; i < channel.length; i += 1) {
        channel[i] = (Math.random() * 2 - 1) * 0.55;
      }

      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuffer;

      const lowpass = audioCtx.createBiquadFilter();
      lowpass.type = "lowpass";
      lowpass.frequency.setValueAtTime(1200, at);

      const noiseGain = audioCtx.createGain();
      noiseGain.gain.setValueAtTime(0.0001, at);
      noiseGain.gain.exponentialRampToValueAtTime(0.07, at + 0.01);
      noiseGain.gain.exponentialRampToValueAtTime(0.0001, at + 0.11);

      const master = audioCtx.createGain();
      master.gain.value = 0.9;
      master.connect(audioCtx.destination);

      tone.connect(toneGain).connect(master);
      noise.connect(lowpass).connect(noiseGain).connect(master);

      tone.start(at);
      tone.stop(at + 0.2);
      noise.start(at);
      noise.stop(at + 0.12);
    }

    async function playKnockSequence() {
      const ready = await ensureSfxReady();
      if (!ready) return;
      [0, 0.43, 0.86, 1.29].forEach((offset) => playKnockHit(offset));
    }

    function playStory() {
      clearStory();
      phaseTimes.forEach((ms, index) => {
        const phase = phases[index];
        timers.push(setTimeout(() => {
          body.classList.add(phase);
          if (phase === "phase-knock") playKnockSequence();
          if (phase === "phase-open") {
            startRains();
            startCountdown();
          }
        }, ms));
      });
    }

    function updateMusicBtn() {
      if (!musicAvailable) {
        musicBtn.disabled = true;
        musicBtn.textContent = "üö´";
        musicBtn.setAttribute("aria-label", "Èü≥‰πê‰∏çÂèØÁî®");
        musicBtn.setAttribute("title", "Èü≥‰πê‰∏çÂèØÁî®");
        return;
      }
      musicBtn.disabled = false;
      if (bgm.paused) {
        musicBtn.textContent = "üîá";
        musicBtn.setAttribute("aria-label", "ÂºÄÂêØÈü≥‰πê");
        musicBtn.setAttribute("title", "ÂºÄÂêØÈü≥‰πê");
      } else if (bgm.muted) {
        musicBtn.textContent = "üîà";
        musicBtn.setAttribute("aria-label", "ÂºÄÂêØÂ£∞Èü≥");
        musicBtn.setAttribute("title", "ÂºÄÂêØÂ£∞Èü≥");
      } else {
        musicBtn.textContent = "üîä";
        musicBtn.setAttribute("aria-label", "ÂÖ≥Èó≠Èü≥‰πê");
        musicBtn.setAttribute("title", "ÂÖ≥Èó≠Èü≥‰πê");
      }
    }

    async function tryPlayMusic() {
      if (!wantsMusic || !musicAvailable) return;
      try {
        bgm.muted = false;
        bgm.volume = 0.48;
        await bgm.play();
        startedMutedAutoplay = false;
        body.classList.remove("music-gesture");
      } catch (_) {
        try {
          // Fallback for strict autoplay policies: start muted, unmute on first interaction.
          bgm.muted = true;
          await bgm.play();
          startedMutedAutoplay = true;
          body.classList.add("music-gesture");
        } catch (_) {
          startedMutedAutoplay = false;
          bgm.muted = false;
          body.classList.add("music-gesture");
        }
      }
      updateMusicBtn();
    }

    function scheduleAutoplayRetries() {
      [180, 680, 1400].forEach((ms) => {
        setTimeout(() => {
          if (wantsMusic && bgm.paused) tryPlayMusic();
        }, ms);
      });
    }

    function autoClickEnableMusic() {
      if (!musicAvailable) return;
      const needEnable = bgm.paused || bgm.muted;
      if (!needEnable) return;
      wantsMusic = true;
      musicBtn.click();
    }

    function scheduleAutoMusicButtonClicks() {
      [90, 360, 920, 1800].forEach((ms) => {
        setTimeout(() => {
          autoClickEnableMusic();
          if (wantsMusic && bgm.paused) tryPlayMusic();
        }, ms);
      });
    }

    function enableSoundIfMuted() {
      if (bgm.paused || !bgm.muted) return;
      bgm.muted = false;
      startedMutedAutoplay = false;
      body.classList.remove("music-gesture");
      updateMusicBtn();
    }

    function toggleMusic() {
      if (!musicAvailable) return;
      if (bgm.paused) {
        wantsMusic = true;
        tryPlayMusic();
        return;
      }

      if (bgm.muted) {
        wantsMusic = true;
        enableSoundIfMuted();
        return;
      }

      wantsMusic = false;
      bgm.pause();
      bgm.muted = false;
      startedMutedAutoplay = false;
      body.classList.remove("music-gesture");
      updateMusicBtn();
    }

    bgm.volume = 0.48;
    bgm.autoplay = true;
    bgm.playsInline = true;
    bgm.addEventListener("error", () => {
      musicAvailable = false;
      wantsMusic = false;
      updateMusicBtn();
    });

    ["pointerdown", "touchstart", "keydown"].forEach((eventName) => {
      document.addEventListener(eventName, () => {
        ensureSfxReady();
        if (startedMutedAutoplay) enableSoundIfMuted();
        if (wantsMusic && bgm.paused) tryPlayMusic();
      });
    });

    if (isIOS) {
      const forceAudibleFromGesture = async () => {
        if (!wantsMusic || !musicAvailable) return;
        await ensureSfxReady();
        if (bgm.paused || bgm.muted) {
          bgm.muted = false;
          try {
            await bgm.play();
            startedMutedAutoplay = false;
            body.classList.remove("music-gesture");
            updateMusicBtn();
          } catch (_) {}
        }
      };

      ["touchstart", "touchend", "click"].forEach((eventName) => {
        document.addEventListener(eventName, forceAudibleFromGesture, { capture: true, passive: true });
      });
    }

    ["pageshow", "focus"].forEach((eventName) => {
      window.addEventListener(eventName, () => {
        if (wantsMusic && bgm.paused) tryPlayMusic();
      });
    });

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible" && wantsMusic && bgm.paused) {
        tryPlayMusic();
      }
    });

    function replayRound(resetMusicPosition = true) {
      playStory();
      if (wantsMusic) {
        if (bgm.paused) {
          tryPlayMusic();
        } else {
          if (resetMusicPosition) bgm.currentTime = 0;
          if (bgm.muted) body.classList.add("music-gesture");
        }
      }
    }

    replayBtn.addEventListener("click", replayRound);

    musicBtn.addEventListener("click", toggleMusic);
    genShareCardBtn.addEventListener("click", downloadShareCard);
    closeShareModalBtn.addEventListener("click", () => {
      setShareModalOpen(false);
      replayRound(false);
    });

    ["contextmenu", "dragstart"].forEach((eventName) => {
      document.addEventListener(eventName, (event) => event.preventDefault());
    });
    document.addEventListener("touchstart", (event) => {
      if (!event.changedTouches || event.changedTouches.length === 0) return;
      if (collectByTouchPoints(event.changedTouches)) {
        event.preventDefault();
      }
    }, { passive: false, capture: true });
    document.addEventListener("touchmove", (event) => {
      if (event.touches && event.touches.length > 1) {
        event.preventDefault();
      }
    }, { passive: false, capture: true });
    ["gesturestart", "gesturechange"].forEach((eventName) => {
      document.addEventListener(eventName, (event) => event.preventDefault(), { passive: false, capture: true });
    });
    document.addEventListener("selectstart", (event) => {
      const target = event.target;
      if (target && target.closest && target.closest("input, textarea")) return;
      event.preventDefault();
    });

    updateScoreBoard();
    updateCountdownBoard();
    updateMusicBtn();
    playStory();
    tryPlayMusic();
    scheduleAutoplayRetries();
    scheduleAutoMusicButtonClicks();
  </script>
</body>
</html>
